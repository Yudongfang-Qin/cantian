conn / as sysdba 
ALTER PROFILE DEFAULT LIMIT PASSWORD_REUSE_MAX 1;
ALTER PROFILE default LIMIT PASSWORD_REUSE_MAX UNLIMITED;
alter profile "DEFAULT" limit PASSWORD_REUSE_TIME 1;
alter profile "default" limit PASSWORD_REUSE_TIME UNLIMITED;
alter profile "DEFAULT" limit PASSWORD_REUSE_TIME UNLIMITED;
-- TESTCASE: USER& PROFILE
SET CTSQL_SSL_MODE=DISABLED;
CREATE PROFILE PROFILE1 LIMIT PASSWORD_GRACE_TIME 0 PASSWORD_GRACE_TIME 20;
CREATE PROFILE PROFILE1 LIMIT PASSWORD_GRACE_TIME 10 PASSWORD_GRACE_TIME 20;
CREATE PROFILE PROFILE1 LIMIT PASSWORD_GRACE_TIME 1 FAILED_LOGIN_ATTEMPTS -1;
CREATE PROFILE PROFILE1 LIMIT FAILED_LOGIN_ATTEMPTS 999999999999999999;
CREATE PROFILE PROFILE1 LIMIT FAILED_LOGIN_ATTEMPTS 2147483647;
CREATE PROFILE PROFILE1 LIMIT FAILED_LOGIN_ATTEMPTS 1;
CREATE PROFILE PROFILE1 LIMIT PASSWORD_GRACE_TIME 10 PASSWORD_GRACE_TIME1 20;
CREATE PROFILE PROFILE1 LIMIT PASSWORD_GRACE_TIME 10  PASSWORD_LOCK_TIME DEFAULT PASSWORD_LIFE_TIME UNLIMITED;
CREATE PROFILE PROFILE1 LIMIT PASSWORD_GRACE_TIME 10  PASSWORD_LOCK_TIME DEFAULT PASSWORD_LIFE_TIME UNLIMITED;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE1' ORDER BY RESOURCE_NAME;

ALTER PROFILE "DEFAULT" LIMIT SESSIONS_PER_USER 99999;
ALTER PROFILE "DEFAULT" LIMIT SESSIONS_PER_USER 4096;
ALTER PROFILE "DEFAULT" LIMIT SESSIONS_PER_USER 8192;
ALTER PROFILE PROFILE1 LIMIT PASSWORD_LIFE_TIME 180 PASSWORD_GRACE_TIME1 DEFAULT PASSWORD_LOCK_TIME 1;
ALTER PROFILE PROFILE2 LIMIT PASSWORD_LIFE_TIME 180 PASSWORD_GRACE_TIME DEFAULT PASSWORD_LOCK_TIME 1;
ALTER PROFILE PROFILE1 LIMIT PASSWORD_LIFE_TIME 180 PASSWORD_GRACE_TIME DEFAULT PASSWORD_LOCK_TIME 1;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE1' ORDER BY RESOURCE_NAME;

DROP PROFILE PROFILE1;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE1' ORDER BY RESOURCE_NAME;
DROP PROFILE PROFILE1;

DROP USER IF EXISTS TEST CASCADE;
CREATE USER TEST IDENTIFIED BY Root1234 PROFILE PROFILE1;
CREATE PROFILE PROFILE1 LIMIT PASSWORD_GRACE_TIME DEFAULT;
CREATE USER TEST IDENTIFIED BY Root1234 PROFILE PROFILE1;
GRANT DBA TO TEST;
SELECT * FROM DB_PROFILES WHERE OWNER = 'TEST' order by RESOURCE_NAME;

CREATE PROFILE PROFILE2 LIMIT PASSWORD_LIFE_TIME DEFAULT;
ALTER USER TEST PROFILE PROFILE2;
SELECT * FROM DB_PROFILES WHERE OWNER = 'TEST' order by RESOURCE_NAME;

DROP PROFILE PROFILE1;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE1' ORDER BY RESOURCE_NAME;

CONNECT  TEST/Root1234@127.0.0.1:1611
CREATE PROFILE PROFILE3 LIMIT PASSWORD_LIFE_TIME 181;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE3' ORDER BY RESOURCE_NAME;
ALTER PROFILE PROFILE3 LIMIT PASSWORD_LIFE_TIME 182;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE3' ORDER BY RESOURCE_NAME;
DROP PROFILE PROFILE3;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE3' ORDER BY RESOURCE_NAME;
CONNECT  sys/Huawei@123@127.0.0.1:1611

ALTER PROFILE PROFILE2 LIMIT FAILED_LOGIN_ATTEMPTS 2;
CONNECT  TEST/Root12345@127.0.0.1:1611
CONNECT  TEST/Root12345@127.0.0.1:1611
CONNECT  TEST/Root12345@127.0.0.1:1611
CONNECT  TEST/Root1234@127.0.0.1:1611
CONNECT  sys/Huawei@123@127.0.0.1:1611
DROP PROFILE PROFILE2;
DROP PROFILE PROFILE2 CASCADE;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE2' ORDER BY RESOURCE_NAME;
SELECT * FROM DB_PROFILES WHERE OWNER = 'TEST' order by RESOURCE_NAME;
DROP USER TEST CASCADE;

create profile "DEFAULT" limit PASSWORD_REUSE_TIME DEFAULT;
create profile "default" limit PASSWORD_REUSE_TIME DEFAULT;
create profile DEFAULT limit PASSWORD_REUSE_TIME DEFAULT;
DROP profile "DEFAULT" cascade;
DROP profile DEFAULT cascade;
DROP profile "default" cascade;
alter profile "DEFAULT" limit PASSWORD_REUSE_TIME 365;
alter profile "DEFAULT" limit PASSWORD_REUSE_MAX 20;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'DEFAULT' ORDER BY RESOURCE_NAME; 
alter profile "DEFAULT" limit PASSWORD_REUSE_TIME UNLIMITED;
alter profile "DEFAULT" limit PASSWORD_REUSE_MAX UNLIMITED;
alter profile profile_a limit SESSIONS_PER_USER unlimited;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'DEFAULT' ORDER BY RESOURCE_NAME;

CREATE PROFILE PROFILE1 LIMIT PASSWORD_LIFE_TIME 3/86400 PASSWORD_GRACE_TIME 3/86400;
CREATE USER TEST IDENTIFIED BY Root1234 PROFILE PROFILE1;
GRANT DBA TO TEST;
SELECT * FROM DBA_PROFILES WHERE PROFILE = 'PROFILE1' ORDER BY RESOURCE_NAME;
CONNECT  TEST/Root1234@127.0.0.1:1611 --success
select sleep(3) from dual;
CONNECT  TEST/Root1234@127.0.0.1:1611  --success,but warning left 2 seconds
select sleep(4) from dual;
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
CONNECT  sys/Huawei@123@127.0.0.1:1611
ALTER USER TEST IDENTIFIED BY Root12345;
CONNECT  TEST/Root12345@127.0.0.1:1611 --success
ALTER PROFILE PROFILE1 LIMIT FAILED_LOGIN_ATTEMPTS 3 PASSWORD_LOCK_TIME 3/86400 PASSWORD_LIFE_TIME DEFAULT PASSWORD_GRACE_TIME DEFAULT;
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
conn sys/Huawei@123@127.0.0.1:1611
grant select on sys.SYS_USERS to TEST;
CONNECT  TEST/Root12345@127.0.0.1:1611 --success
select ASTATUS, LCOUNT from sys.SYS_USERS where NAME = 'TEST';
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed, but lock
CONNECT  TEST/Root12345@127.0.0.1:1611 --failed,but lock
CONNECT  sys/Huawei@123@127.0.0.1:1611
select ASTATUS, LCOUNT from SYS_USERS where NAME = 'TEST';
select sleep(1) from dual;
CONNECT  TEST/Root12345@127.0.0.1:1611 --failed
CONNECT  sys/Huawei@123@127.0.0.1:1611
select sleep(3) from dual;
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed
CONNECT  TEST/Root1234@127.0.0.1:1611 --failed, lock
CONNECT  sys/Huawei@123@127.0.0.1:1611
select ASTATUS, LCOUNT from SYS_USERS where NAME = 'TEST';
ALTER USER TEST ACCOUNT UNLOCK;
CONNECT TEST/Root12345@127.0.0.1:1611
ALTER USER TEST ACCOUNT LOCK;
CONNECT TEST/Root12345@127.0.0.1:1611 -- failed
CONNECT  sys/Huawei@123@127.0.0.1:1611
select ASTATUS from SYS_USERS where NAME = 'TEST';
ALTER USER TEST ACCOUNT UNLOCK PASSWORD EXPIRE;
ALTER PROFILE PROFILE1 LIMIT FAILED_LOGIN_ATTEMPTS DEFAULT PASSWORD_LOCK_TIME DEFAULT;
CONNECT sys/Huawei@123@127.0.0.1:1611
ALTER USER TEST IDENTIFIED BY Root1234;
CONNECT TEST/Root12345@127.0.0.1:1611 --failed
CONNECT TEST/Root1234@127.0.0.1:1611  --success
CONNECT sys/Huawei@123@127.0.0.1:1611
drop profile profile1 cascade;
drop user test cascade;

CREATE PROFILE PROFILE_PASSWD LIMIT PASSWORD_REUSE_TIME DEFAULT PASSWORD_REUSE_MAX DEFAULT;
CREATE USER TEST IDENTIFIED BY Root1234 PROFILE PROFILE_PASSWD;
ALTER USER TEST IDENTIFIED BY Root1234;--SUCCESS
ALTER PROFILE PROFILE_PASSWD LIMIT PASSWORD_REUSE_TIME 1/1440 PASSWORD_REUSE_MAX UNLIMITED;
ALTER USER TEST IDENTIFIED BY Root1235;--SUCCESS
ALTER USER TEST IDENTIFIED BY Root1235;--FAILED
ALTER PROFILE PROFILE_PASSWD LIMIT PASSWORD_REUSE_TIME UNLIMITED PASSWORD_REUSE_MAX 10;
ALTER USER TEST IDENTIFIED BY Root1236;--SUCCESS
ALTER USER TEST IDENTIFIED BY Root1236;--FAILED
ALTER PROFILE PROFILE_PASSWD LIMIT PASSWORD_REUSE_TIME 3/86400 PASSWORD_REUSE_MAX 2;
ALTER USER TEST IDENTIFIED BY Root1237;--SUCCESS
ALTER USER TEST IDENTIFIED BY Root1235;--FAILED
connect TEST/Root1235@127.0.0.1:1611
connect sys/Huawei@123@127.0.0.1:1611
SELECT sleep(4) from dual;
ALTER USER TEST IDENTIFIED BY Root1235;--SUCCESS
ALTER PROFILE PROFILE_PASSWD LIMIT PASSWORD_REUSE_MAX 10;
ALTER USER TEST IDENTIFIED BY Root1236;--FAILED
CREATE or replace procedure profile_passwd_000(startnum int, endall int) is
i INT :=1;
j varchar(20);
str varchar(100);
BEGIN
  FOR i IN startnum..endall LOOP
    select 'Changeme_' || i into j from dual;
    str := 'ALTER USER TEST IDENTIFIED BY ' || j;
    execute immediate str;
  END LOOP;
END;
/
call profile_passwd_000(1, 6);
ALTER USER TEST IDENTIFIED BY Root1236;--FAILED
call profile_passwd_000(8, 9);
ALTER USER TEST IDENTIFIED BY Root1236;--SUCCESS
drop procedure profile_passwd_000;
drop profile PROFILE_PASSWD cascade;
drop user TEST cascade;

CREATE PROFILE PROFILE_CHG_PSW_LOCK LIMIT FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 2/86400;
CREATE USER TEST IDENTIFIED BY Root1234 PROFILE PROFILE_CHG_PSW_LOCK;
grant dba to test;
connect TEST/Root1234@127.0.0.1:1611
ALTER USER TEST IDENTIFIED BY Root12356789 REPLACE Root1235;--FAILED
ALTER USER TEST IDENTIFIED BY Root12356789 REPLACE Root1235;--FAILED
ALTER USER TEST IDENTIFIED BY Root12356789 REPLACE Root1235;--LOCK
connect TEST/Root1234@127.0.0.1:1611 --FAILED
connect sys/Huawei@123@127.0.0.1:1611
select sleep(3) from dual;
connect TEST/Root1234@127.0.0.1:1611 --SUCCESS
connect TEST/Root1235@127.0.0.1:1611 --FAILED
connect TEST/Root1234@127.0.0.1:1611 --SUCCESS
ALTER USER TEST IDENTIFIED BY Root12356789 REPLACE Root1235;--FAILED
ALTER USER TEST IDENTIFIED BY Root12356789 REPLACE Root1234;--LOCK
conn sys/Huawei@123@127.0.0.1:1611
grant select on sys.SYS_USERS to TEST;
connect TEST/Root12356789@127.0.0.1:1611 --SUCCESS
select ASTATUS, LCOUNT from sys.SYS_USERS where NAME = 'TEST'; 
connect sys/Huawei@123@127.0.0.1:1611
drop profile PROFILE_CHG_PSW_LOCK cascade;
drop user TEST cascade;
SET CTSQL_SSL_MODE=PREFERRED;

--TEST the  maximum of profile, MAX_PROFILE_SIZE=4096=CT_SHARED_PAGE_SIZE / sizeof(pointer_t)
create or replace procedure batch_create_test_profile
is
    v_createsql varchar2(400);
 v_count number(9);
begin
    select count(distinct profile) into v_count from dba_profiles;
 if v_count < 4096 then
    FOR i IN v_count+1..4096 LOOP
    v_createsql:='CREATE PROFILE PROFILETESTMAX'||i||' LIMIT PASSWORD_GRACE_TIME 10';
    execute immediate v_createsql;
 END LOOP;
 end if;
end;
/

create or replace procedure batch_drop_test_profile
is
    v_createsql varchar2(400);
 cursor c_profile is select distinct profile from  dba_profiles where profile  like 'PROFILETESTMAX%';
 profie_t c_profile%rowtype;
begin
    FOR profie_t IN c_profile   LOOP
    v_createsql:='drop profile '||profie_t.profile||'';
    execute immediate v_createsql;
 END LOOP;
end;
/

call batch_drop_test_profile;
call batch_create_test_profile;
select count(distinct profile)  from dba_profiles; 
create profile PROFILETESTMAX4097 LIMIT PASSWORD_GRACE_TIME 10;--error max exceeded
call batch_drop_test_profile;

drop procedure if exists batch_create_test_profile;
drop procedure if exists batch_drop_test_profile;

CREATE PROFILE P_User_A_01 LIMIT PASSWORD_REUSE_TIME 3/8640 PASSWORD_REUSE_MAX 3;
drop user if exists User_A_01 cascade;
create user User_A_01 identified by Cantian_234 profile P_User_A_01;
select sleep(3);
alter user User_A_01 identified by Gauaa_234 replace Cantian_234;
alter user User_A_01 identified by Cantian_234 replace Gauaa_234;
drop user if exists User_A_01 cascade;
drop profile P_User_A_01 cascade;


create  profile TEST_SESSIONS_PER_USER_PROFILE limit SESSIONS_PER_USER default;
select * from dba_profiles where profile = 'TEST_SESSIONS_PER_USER_PROFILE' and resource_name ='SESSIONS_PER_USER';
drop profile TEST_SESSIONS_PER_USER_PROFILE;

--DTS2019061801185
drop user if exists test_0001;
create  profile test_0001_profile limit PASSWORD_REUSE_TIME 1/86400 PASSWORD_REUSE_MAX 1;
create user test_0001 identified by 'cantian_234';
ALTER USER test_0001 PROFILE test_0001_profile;
alter user test_0001 identified by 'cantian_234';
select sleep(5);
alter user test_0001 identified by 'cantian_234';
DROP USER test_0001 CASCADE;
DROP PROFILE test_0001_profile CASCADE;

CREATE PROFILE PROFILE_ligang003 LIMIT PASSWORD_LIFE_TIME 180;
drop user if exists ligang_test003;
CREATE USER ligang_test003 IDENTIFIED BY Root1234 PROFILE PROFILE_ligang003;
drop profile PROFILE_ligang003;
drop profile PROFILE_ligang003 cascade;
drop user if exists ligang_test003;

CREATE PROFILE PROFILE_ligang002 LIMIT PASSWORD_REUSE_TIME 1/86400 PASSWORD_REUSE_MAX 2;
drop user if exists ligang_test002 cascade;
create user ligang_test002 identified by Gauaa_234 profile PROFILE_ligang002;
select sleep(2);
alter user ligang_test002 identified by Cantian_234 replace Gauaa_234;
alter user ligang_test002 identified by aass_234 replace Cantian_234;
alter user ligang_test002 identified by Gauaa_234 replace aass_234;
drop user if exists ligang_test002 cascade;
drop profile PROFILE_ligang002 cascade;

--DTS2019082600671
CREATE PROFILE PROFILE_lingfeng001 LIMIT PASSWORD_LIFE_TIME  24856;
CREATE PROFILE PROFILE_lingfeng001 LIMIT PASSWORD_REUSE_TIME 24856;
CREATE PROFILE PROFILE_lingfeng001 LIMIT PASSWORD_LOCK_TIME  24856;
CREATE PROFILE PROFILE_lingfeng001 LIMIT PASSWORD_GRACE_TIME 24856;
CREATE PROFILE PROFILE_lingfeng001 LIMIT PASSWORD_LIFE_TIME 24855 PASSWORD_REUSE_TIME 24855 PASSWORD_LOCK_TIME 24855 PASSWORD_GRACE_TIME 24855;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_LIFE_TIME 24856;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_REUSE_TIME 24856;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_LOCK_TIME 24856;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_GRACE_TIME 24856;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_LIFE_TIME 24855;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_REUSE_TIME 24855;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_LOCK_TIME 24855;
alter PROFILE PROFILE_lingfeng001 limit PASSWORD_GRACE_TIME 24855;
drop profile PROFILE_lingfeng001 cascade;